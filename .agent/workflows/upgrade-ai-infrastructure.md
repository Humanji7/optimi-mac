# Upgrade AI Infrastructure

---
description: Умно обновляет AI-инфраструктуру проекта без разрушения существующих конфигов
---

## КРИТИЧЕСКИ ВАЖНО

**ЭТО НЕ ПЕРЕЗАПИСЬ. ЭТО УМНЫЙ МЕРЖ.**

Ты ОБЯЗАН:
1. Сначала изучить ВСЁ что есть
2. Оценить качество существующего
3. Добавить только недостающее
4. ПОКАЗАТЬ DIFF перед изменениями
5. Получить подтверждение пользователя

---

## Фаза 1: Инвентаризация (READ-ONLY)

Найди и прочитай ВСЕ существующие конфиги:

```bash
# Что искать:
find . -name "CLAUDE.md" -o -name ".cursorrules" -o -name "*.mdc" 2>/dev/null
find . -path "*/.agent/*" -type f 2>/dev/null
find . -path "*/docs/*" -name "*.md" 2>/dev/null
ls -la .cursor/rules/ 2>/dev/null
```

Создай отчёт в памяти:

```
СУЩЕСТВУЮЩАЯ ИНФРАСТРУКТУРА:
├── CLAUDE.md: [ЕСТЬ/НЕТ] — [краткое содержание]
├── .agent/
│   ├── rules.md: [ЕСТЬ/НЕТ] — [что покрывает]
│   ├── context.md: [ЕСТЬ/НЕТ] — [актуальность]
│   ├── workflows/: [список существующих]
│   └── memory/: [что там]
├── .cursorrules: [ЕСТЬ/НЕТ] — [размер, качество]
└── docs/: [какие AI-релевантные доки]
```

---

## Фаза 2: Gap Analysis

Проверь наличие КРИТИЧНЫХ компонентов:

### Обязательные (добавить если нет):
- [ ] **GUPP Infrastructure:**
  - [ ] `.agent/HOOK.md` placeholder или README
  - [ ] `.agent/hooks/` директория для архива
- [ ] **MEOW Workflows:**
  - [ ] Decompose workflow (разбивка на molecules)
  - [ ] Anti-crash/GUPP rules
- [ ] **Handoff Protocol:**
  - [ ] Шаблон Handoff History в HOOK.md
  - [ ] Resume commands документация
- [ ] **Memory Bank:**
  - [ ] TASKS.md, DECISIONS.md, LEARNINGS.md

### Опциональные (предложить если нет):
- [ ] Per-project context.md
- [ ] Типовые workflows (feature, bugfix, refactor)
- [ ] Code review промпты
- [ ] Git hooks

### Оценка существующего:
```
Для каждого существующего файла:
- Дата последнего изменения
- Покрывает ли anti-crash? [ДА/НЕТ]
- Покрывает ли decompose? [ДА/НЕТ]  
- Устарел ли контент? [ДА/НЕТ/НЕЯСНО]
- Конфликтует с новыми правилами? [ДА/НЕТ]
```

---

## Фаза 3: Proposal (БЕЗ ИЗМЕНЕНИЙ!)

Сформируй ПРЕДЛОЖЕНИЕ для пользователя:

```markdown
# Предложение по обновлению AI-инфраструктуры

## Что оставляем без изменений (хорошо):
- [файл]: [причина]

## Что ДОПОЛНЯЕМ (append, не replace):
- [файл]: добавляем секцию [X]
  ```diff
  + [что добавится]
  ```

## Что СОЗДАЁМ (новые файлы):
- [путь]: [описание]

## Что предлагаем ОБНОВИТЬ (требует ревью):
- [файл]: [что устарело] → [что предлагаем]

## Что НЕ ТРОГАЕМ (непонятно/рискованно):
- [файл]: [причина осторожности]
```

**СТОП! Жди подтверждения пользователя.**

---

## Фаза 4: Execution (только после OK)

После подтверждения:

1. **Append-only для существующих файлов:**
   ```bash
   # НЕ делай: echo "..." > file.md (перезапись)
   # Делай: echo "..." >> file.md (дополнение)
   # Или: умный мерж с сохранением существующего
   ```

2. **Создание новых файлов** в недостающих местах

3. **Бэкап перед изменениями:**
   ```bash
   # Для каждого изменяемого файла:
   cp file.md file.md.backup.$(date +%Y%m%d)
   ```

4. **Коммит с детальным описанием:**
   ```bash
   git add .
   git commit -m "chore: upgrade AI infrastructure (smart merge)
   
   Added:
   - Anti-crash rules
   - Decompose workflow
   
   Preserved:
   - Existing CLAUDE.md content
   - Custom project rules
   
   Backup created for modified files"
   ```

---

## Примеры умного мержа

### Пример 1: CLAUDE.md уже есть

**Плохо:**
```bash
# Перезаписать CLAUDE.md новым содержимым
```

**Хорошо:**
```bash
# Добавить в конец секцию Anti-Crash:
cat >> CLAUDE.md << 'EOF'

---

## Anti-Crash Protocol (added 2026-01-10)

[правила декомпозиции]
EOF
```

### Пример 2: .agent/ частично есть

**Плохо:**
```bash
# rm -rf .agent && создать заново
```

**Хорошо:**
```bash
# Добавить только недостающие файлы:
# - .agent/workflows/decompose.md (НОВЫЙ)
# - .agent/memory/DECOMPOSITION.md (НОВЫЙ)
# Не трогать:
# - .agent/rules.md (УЖЕ ЕСТЬ, хороший)
```

---

## Мантры

> "Существующий контент — это знания проекта. Не удаляй знания."

> "Append > Replace. Всегда."

> "Сомневаешься — спроси пользователя."

> "Бэкап ничего не стоит. Потеря данных стоит дорого."

---

## Чеклист перед завершением

- [ ] Показал пользователю что нашёл
- [ ] Показал diff всех изменений
- [ ] Получил подтверждение
- [ ] Создал бэкапы
- [ ] Добавил только недостающее
- [ ] Сохранил всё существующее
- [ ] Закоммитил с понятным сообщением
